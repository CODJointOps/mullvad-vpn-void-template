pkgname=mullvad-vpn
version=2025.14
revision=2
archs="x86_64* aarch64*"
maintainer="Wizzard <rich@bandaholics.cash>"
short_desc="Mullvad VPN client"
homepage="https://mullvad.net/"
license="LicenseType"
hostmakedepends="tar xz"

case "${XBPS_TARGET_MACHINE}" in
    x86_64*)
        _deb_arch=amd64
        checksum=247b981e2e2e047ccca296b8e62a70b1dc7fdcec7f17137795884100240e0a41
        ;;
    aarch64*)
        _deb_arch=arm64
        checksum=9a20a1d71eac09c01b83d897ed227361cc49f0321054d76b83a6f7f61b7c813c
        ;;
esac

distfiles="https://github.com/mullvad/mullvadvpn-app/releases/download/${version}/MullvadVPN-${version}_${_deb_arch}.deb"

do_extract() {
    ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/MullvadVPN-${version}_${_deb_arch}.deb"
    tar xf data.tar.xz -C ${wrksrc}
    mv ${wrksrc}/opt/Mullvad\ VPN ${wrksrc}/opt/MullvadVPN
}

do_install() {
    vmkdir /usr/bin
    vmkdir /usr/lib/systemd/system
    vmkdir /usr/share/bash-completion/completions
    vmkdir /usr/share/fish/vendor_completions.d
    vmkdir /usr/share/icons/hicolor
    vmkdir /usr/share/applications
    vmkdir /usr/share/doc/mullvad-vpn
    vmkdir /usr/share/zsh/site-functions

    vmkdir /etc/sv/mullvad
    echo '#!/bin/sh' > ${DESTDIR}/etc/sv/mullvad/run
    echo 'exec 2>&1' >> ${DESTDIR}/etc/sv/mullvad/run
    echo 'sv check dbus > /dev/null || exit 1' >> ${DESTDIR}/etc/sv/mullvad/run
    echo 'exec /usr/bin/mullvad-daemon -v --disable-stdout-timestamps' >> ${DESTDIR}/etc/sv/mullvad/run
    chmod 755 ${DESTDIR}/etc/sv/mullvad/run

    vcopy usr/bin/* /usr/bin/
    vcopy usr/lib/systemd/system/* /usr/lib/systemd/system/
    vcopy usr/share/icons/hicolor/* /usr/share/icons/hicolor/
    vcopy usr/share/applications/* /usr/share/applications/
    vcopy usr/share/doc/mullvad-vpn/* /usr/share/doc/mullvad-vpn/
    vcopy usr/share/bash-completion/completions/* /usr/share/bash-completion/completions/
    vcopy usr/share/fish/vendor_completions.d/* /usr/share/fish/vendor_completions.d/

    vmkdir /usr/share/zsh/site-functions

    mkdir -p ${DESTDIR}/opt/MullvadVPN
    cp -a ${wrksrc}/opt/MullvadVPN/* ${DESTDIR}/opt/MullvadVPN/
    ln -sf /opt/MullvadVPN ${DESTDIR}/opt/Mullvad\ VPN
}

pkg_install() {
    vmove usr/local/share/zsh/site-functions/*
}
